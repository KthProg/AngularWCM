function Form($scope,$http){$scope.fields={};$scope.queries={};var name="";var table="";var pk="";$scope.id=-1;var contacts=[];var emailBody="";var connection="";$scope.hasRecord=false;$scope.setFormData=function(formName){name=formName;$http.get("/json/FormData.json").success(function(resp){connection=resp[name]["Connection"];table=resp[name]["Table"];pk=resp[name]["PK"];addContacts(resp[name]["Emails"]);$scope.queries=resp[name]["Queries"];getMaxID();getInitialOptions();watchSelects()})};var getMaxID=function(){$http({method:"POST",url:"/scripts/php/getMaxID.php",data:fieldsToRequestString()+"&"+getFormDataString(),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(resp){$scope.id=Number(++resp)})};var getInitialOptions=function(){for(var q in $scope.queries){if($scope.queries[q].params.length==0){getOptions(q)}}};var getOptions=function(field){var vals=replaceParamsWithValues($scope.queries[field].params);$http.get("/scripts/php/Query.php?Query="+encodeURIComponent($scope.queries[field].name)+"&Params="+encodeURIComponent(JSON.stringify(vals))).success(function(resp){$scope.queries[field].options=resp})};var replaceParamsWithValues=function(params){var results=[];for(var i=0,l=params.length;i<l;++i){if(params[i].ref){var refVal=refNameToValue(params[i].returns,params[i].name);results.push(refVal)}else{results.push(params[i].name)}}return results};var refNameToValue=function(type,refName){switch(type){case'value':var refVal=$scope.fields[refName];break;case'text':var refEl=getFieldEl(refName).find('option:selected');var refVal=refEl.text();break}return refVal};var watchSelects=function(){for(var q in $scope.queries){var prms=$scope.queries[q].params;if(prms.length>0){var lastEl=prms.slice(-1).pop();var watch=lastEl.name;var updateStr="getOptions('"+q+"')";(function(str){$scope.$watch("fields['"+watch+"']",function(){eval(str)})})(updateStr)}}};$scope.open=function(){var id=prompt('Enter the id of the form you would like to open');if(!(id==undefined||isNaN(id))){$scope.id=id}$http({method:"POST",url:"/scripts/php/Open.php",data:getFormDataString(),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(resp){if(resp!==null&&typeof resp==='object'){$scope.hasRecord=true;$scope.id=Number(resp[pk]);delete resp[pk];for(var v in resp){if(getFieldEl(v)){$scope.fields[v]=resp[v]}}if(resp["SketchURL"]!=undefined){$scope.fields["SketchURL"]=resp["SketchURL"];showSketch($scope.fields["SketchURL"])}formatSrvToClient()}else{alert(name+" number "+$scope.id+" does not exist!")}})};var getFieldEl=function(field){var fe=$('[ng-model="fields[\''+field+'\']"]');if(fe.length!==0){return fe}else{return false}};var showSketch=function(sketchURL){var sketchArea=$("canvas");var sketchCtx=sketchArea[0].getContext("2d");var img=new Image();img.src=sketchURL.replace(/ /g,"+");img.onload=function(){sketchCtx.drawImage(img,0,0)}};var formatSrvToClient=function(){for(var k in $scope.fields){f=$scope.fields[k];if(f==null||f==undefined){$scope.fields[k]=""}else{$scope.fields[k]=""+f}var scopeField;if(scopeField=getFieldEl(k)){switch(scopeField.attr("type")){case"date":case"time":case"datetime-local":$scope.fields[k]=new Date(Date.parse(f));break;case"number":case"range":case"checkbox":$scope.fields[k]=Number(f);break}}}};$scope.update=function(){updateOrSubmit(true)};$scope.submit=function(){updateOrSubmit(false)};var updateOrSubmit=function(updating){if(formIsValid()){emailBody=alterHTMLForEmail();formatClientToSrv();$http({method:"POST",url:"/scripts/php/"+(updating?"Update":"Submit")+".php",data:fieldsToRequestString()+"&"+getFormDataString(),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(resp){$(document.body).html(resp)})}else{alert("Some inputs are not valid, these should appear highlighted in red. Fill these out to submit the form.")}};var formIsValid=function(){return $.makeArray($("select, input, textarea")).reduce(function(p,c){return(p&&(([].indexOf.call(document.querySelectorAll(":invalid"),c)==-1)||$(c).is(':hidden')))},true)};var formatClientToSrv=function(){for(var k in $scope.fields){var f=$scope.fields[k];if(f==null||f==undefined){f=""}var scopeField;if(scopeField=getFieldEl(f)){switch(scopeField.attr("type")){case"date":try{$scope.fields[k]=f.toISOString().split("T")[0]+" 00:00:00.000"}catch(e){$scope.fields[k]=""}break;case"datetime-local":$scope.fields[k].setHours(f.getHours()-5);try{$scope.fields[k]=f.toISOString().replace("T"," ").replace("Z","")}catch(e){$scope.fields[k]=""}break;case"time":$scope.fields[k].setHours(f.getHours()-5);try{$scope.fields[k]=f.toISOString().split("T")[1].replace("Z","")}catch(e){$scope.fields[k]=""}break}}}};var getFormDataString=function(){var dataObj={Name:name,Table:table,PK:pk,ID:$scope.id,Contacts:contacts.join(";"),EmailBody:emailBody,Connection:connection}return"FormData="+encodeURIComponent(JSON.stringify(dataObj))};var fieldsToRequestString=function(){return"Fields="+encodeURIComponent(JSON.stringify($scope.fields))};$scope.clear=function(){window.location.reload()};$scope.$on('uploadImage',function(event,args){if(args.name!=""&&args.URI!=""){$http({method:"POST",url:"/scripts/php/SaveImage.php",data:"Image="+encodeURIComponent(args.URI)+"&FileName="+encodeURIComponent(args.name)+"&Line="+encodeURIComponent(args.line)+"&"+getFormDataString(),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(alert)}});$scope.saveSketch=function(e){$scope.fields["SketchURL"]=e.target.toDataURL().replace(/ /g,"+")};$scope.$watchCollection("[fields['PlantID'], fields['DepartmentID'], fields['ZoneID']]",function(n,o){getSupervisorEmailsByLocation(o[0],o[1],o[2],function(resp){var respArray=objectValuesToArray(resp);removeContacts(respArray)});getSupervisorEmailsByLocation(n[0],n[1],n[2],function(resp){var respArray=objectValuesToArray(resp);addContacts(respArray)})},true);var getSupervisorEmailsByLocation=function(plantid,deptid,zoneid,callback){$http.get("/scripts/php/Query.php?Query=SupervisorEmailsByLocation&Params="+encodeURIComponent(JSON.stringify([plantid||"1",deptid||"0",zoneid||"0"]))).success(callback)};var removeContacts=function(arr){for(var i=0,l=arr.length;i<l;++i){var index=contacts.indexOf(arr[i]);if(index>-1){contacts.splice(index,1)}}};var addContacts=function(arr){contacts=contacts.concat(arr)}}app.controller("Form",Form);